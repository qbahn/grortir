"""File which contains data for testing regression with matlab script."""
from unittest import TestCase
from unittest.mock import patch

import networkx as nx
import numpy as np

from grortir.main.model.processes.factories.calls_process_factory import \
    CallsProcessFactory
from grortir.main.optimizers.grouped_optimizer import GroupedOptimizer
from grortir.main.optimizers.grouping_strategy import GroupingStrategy
from grortir.main.pso.calls_optimization_strategy import \
    CallsOptimizationStrategy
from grortir.main.pso.pso_algorithm import PsoAlgorithm


class TestLinearRVT(TestCase):
    """Test class for regression."""

    def _regression_mocked(self, rand_mock, max_calls):
        """Test use some mocked values of random function from one known example
         from matlab. Because we set the same values in rand function, we should
        have equal values as in matlab. This is working example for 3 particles,
         5 stages, 2 dimensions when all stages are in one group.
         """
        prepare_rand_mock(rand_mock)
        how_many_particles = 3
        max_calls = max_calls
        calls_factory = CallsProcessFactory("linear", 5,
                                            max_calls,
                                            [0, 0])
        process = calls_factory.construct_process()
        ordered_stages = nx.topological_sort(process)

        grouping_strategy = GroupingStrategy(ordered_stages)
        grouping_strategy.define_group(ordered_stages)
        optimization_startegy = CallsOptimizationStrategy()
        pso_algortihm = PsoAlgorithm(process, grouping_strategy,
                                     optimization_startegy,
                                     how_many_particles)
        optimizer = GroupedOptimizer(process, grouping_strategy, pso_algortihm)

        optimizer.optimize_process()

        for index, stage in enumerate(ordered_stages):
            self.assertAlmostEqual(stage.final_quality,
                                   EXPECTED_RESULTS_X2_MATLAB[max_calls][index],
                                   7)

    @patch('grortir.main.pso.velocity_calculator.np.random.rand')
    def test_matlab_regression_x2_300(self, rand_mock):
        """Test case for max_calls = 300."""
        self._regression_mocked(rand_mock, 300)

    @patch('grortir.main.pso.velocity_calculator.np.random.rand')
    def test_matlab_regression_x2_102(self, rand_mock):
        """Test case for max_calls = 102."""
        self._regression_mocked(rand_mock, 102)


EXPECTED_RESULTS_X2_MATLAB = {102: [
    0.196381073803784,
    0.182060227702233,
    0.077236432031289,
    0.044953250296990,
    0.121949294446318
], 300: [
    0.175906072353589,
    0.174734347239612,
    0.042669220710921,
    0.077825241269615,
    0.175914451614580
]}


def prepare_rand_mock(rand_mock):
    """Rand mock for:
        3 particles
        5 stages
        2 dimensions
    """
    returned_values = [  # rand_vec - positions particle 1
        [0.076308289, 0.909593528],
        [0.723465178, 0.93120602],
        [0.501120464, 0.9501295],
        [0.499882501, 0.909128375],
        [0.380941133, 0.750409859],

        # rand_vec - initial_velocities particle 1
        [0.20484909, 0.719324123],
        [0.477401155, 0.180451619],
        [0.768647507, 0.426453573],
        [0.276049048, 0.414885978],
        [0.657399463, 0.709394394],

        # rand_vec - positions particle 2
        [0.779918792, 0.213385354],
        [0.977989512, 0.024899228],
        [0.072051133, 0.230302879],
        [0.679229996, 0.133169446],
        [0.065936347, 0.669013241],

        # rand_vec - initial_velocities particle 2
        [0.490765889, 0.412991829],
        [0.365890386, 0.741118873],
        [0.313994677, 0.634379869],
        [0.452842933, 0.001426881],
        [0.370351083, 0.524345597],

        # rand_vec - positions particle 3
        [0.438409231, 0.452123962],
        [0.53849587, 0.600548917],
        [0.26843898, 0.548489919],
        [0.803739036, 0.523412581],
        [0.288145599, 0.46775286],

        # rand_vec - initial_velocities particle 3
        [0.372384689, 0.906423269],
        [0.837917994, 0.422374044],
        [0.572625333, 0.522906201],
        [0.352978366, 0.092262346],
        [0.459092978, 0.696160464],

        # rand_1
        0.955468323002926,
        # rand_2
        0.682913854375418,
        # etc.
        0.053128690672958,
        0.308852684863797,
        0.592594687323373,
        0.235120407257464,
        0.964970999536127,
        0.945048223792794,
        0.848400880837689,
        0.472323996288402,
        0.841476714898397,
        0.131110642347914,
        0.308733657297835,
        0.462996394154417,
        0.741847200683467,
        0.485825228708897,
        0.136876118797451,
        0.343536529704358,
        0.324426169672443,
        0.300418904318040,
        0.165501400465787,
        0.414901772573252,
        0.448120657502723,
        0.774900375814017,
        0.796390700782548,
        0.522390128001612,
        0.460630296163277,
        0.778213601543897,
        0.887288951852735,
        0.674918769866788,
        0.800479048998464,
        0.939111353732185,
        0.040655809436686,
        0.875671724870083,
        0.276563072451134,
        0.475764499424244,
        0.796760956931902,
        0.717242232275230,
        0.147147571941693,
        0.658748258954145,
        0.069252070009835,
        0.357070628352879,
        0.812829550163706,
        0.427704833027551,
        0.599854437543446,
        0.728161283147134,
        0.821227608306559,
        0.760515119980283,
        0.007143275278998,
        0.420256833672535,
        0.463136218038147,
        0.055499503112723,
        0.541442132095220,
        0.607770751443867,
        0.828453194996125,
        0.941809268191449,
        0.128147854002733,
        0.230430674410219,
        0.659158397070561,
        0.132473988816749,
        0.224078636946319,
        0.574862587589149,
        0.169523723566209,
        0.782230151323778,
        0.856975626111760,
        0.033674204502848,
        0.532644804943674,
        0.796951357443564,
        0.975139681157116,
        0.274258593194421,
        0.169101063365383,
        0.876700930181635,
        0.909182463760849,
        0.197532889467157,
        0.441529742702640,
        0.719232141692337,
        0.845345158763973,
        0.168275305367244,
        0.664968962904761,
        0.807835459296069,
        0.549714120800727,
        0.164716658779013,
        0.035528804830363,
        0.281533817848494,
        0.807870846453552,
        0.044766260845139,
        0.008216505039312,
        0.361616647712057,
        0.063622285698552,
        0.149486303324230,
        0.023190368099362,
        0.524719836768632,
        0.696695902189413,
        0.427053493013728,
        0.134570458644688,
        0.331357210962406,
        0.590345854306335,
        0.940661393396388,
        0.992557719172640,
        0.241602916653850,
        0.010579906938346,
        0.830640325993805,
        0.926612937770057,
        0.458603479767969,
        0.771442344563682,
        0.866199034084391,
        0.609614798334559,
        0.872627183144187,
        0.023903026142331,
        0.271595220259564,
        0.277219582694295,
        0.120632428306158,
        0.910713454288238,
        0.030439266665623,
        0.672561029522113,
        0.071339687257207,
        0.360780493785221,
        0.418099542677566,
        0.181404289057367,
        0.521014103282176,
        0.534991760927916,
        0.317043881936196,
        0.737088059552291,
        0.160202410619170,
        0.192508218959855,
        0.354511018045606,
        0.378376133431419,
        0.206285856500654,
        0.918709205142268,
        0.828093569546948,
        0.106876744256641,
        0.369485915660384,
        0.232671095631974,
        0.451078602950542,
        0.276317186210793,
        0.501806891118423,
        0.922603153077957,
        0.382511138929834,
        0.650128328628633,
        0.595621113020374,
        0.751953561142208,
        0.061665330169869,
        0.744823673681810,
        0.946275927172428,
        0.603559551695486,
        0.287579942119900,
        0.672369218429286,
        0.712048786781395,
        0.656450286538602,
        0.146930315693544,
        0.973475568269701,
        0.955383451820879,
        0.424625532795641,
        0.593637329408872,
        0.039628573866894,
        0.988634334561939,
        0.818744992623299,
        0.636502342429667,
        0.761084744221686,
        0.188029928582586,
        0.307654590092852,
        0.246393644285721,
        0.596049120125150,
        0.091904852163772,
        0.895609985214942,
        0.462275942130728,
        0.444812364954379,
        0.104711303573244,
        0.684904037060114,
        0.816893994342448,
        0.629550171462332,
        0.242022607464133,
        0.785420721585510,
        0.145679433383434,
        0.827276328979597,
        0.580705370611886,
        0.289372811578436,
        0.513243399843739,
        0.628851403064647,
        0.258589498592646,
        0.846906560459974,
        0.421253708599273,
        0.892337457255232,
        0.835468561147535,
        0.099347514159631,
        0.646254109448792,
        0.310494566495742,
        0.754053196983175,
        0.542631657447731,
        0.457598874651717,
        0.895366784537062,
        0.057253559800168,
        0.557317625867979,
        0.327911099296676,
        0.035273336313463,
        0.753518518702918,
        0.561740656068876,
        0.894145336956216,
        0.598261227571831,
        0.337034279430268,
        0.985219655379547,
        0.115714050609305,
        0.052601742578789,
        0.732621909452081,
        0.370874899289484,
        0.361465078628537,
        0.876532156489572,
        0.327293646515387,
        0.888988596884109,
        0.643987979231622,
        0.329049543886762,
        0.059532654412467,
        0.245109352640558,
        0.968413201216849,
        0.405267640233955,
        0.160033461445328,
        0.298013249200853,
        0.899575778861325,
        0.164976715508502,
        0.777860066567281,
        0.134864631396897,
        0.961393713437924,
        0.530205386091562,
        0.043169935597521,
        0.930954677740200,
        0.358225544459122,
        0.731421278900107,
        0.523708014799748,
        0.092581803144957,
        0.106059218020559,
        0.149224950691087,
        0.161200009216847,
        0.052755793124503,
        0.047013165032900,
        0.948428296058719,
        0.091291789989614,
        0.508351675888390,
        0.118629820373576,
        0.214787851208711,
        0.763072072781084,
        0.938134821028349,
        0.469712694723217,
        0.005641953918998,
        0.999208301397325,
        0.047773212685936,
        0.389447904030537,
        0.539056700681636,
        0.891733437554219,
        0.823112111660542,
        0.609386641044624,
        0.398602290975866,
        0.834478719162267,
        0.869058386305670,
        0.871904907345985,
        0.717636435413349,
        0.097787343977917,
        0.298579428134399,
        0.485922055987473,
        0.505053367201341,
        0.832873412737514,
        0.237836773702923,
        0.664590755548858,
        0.374199897461594,
        0.775482553226357,
        0.195774329322454,
        0.476627293393027,
        0.103558580363407,
        0.211990174132978,
        0.935174686344270,
        0.316047110507828,
        0.892977004089998,
        0.524303087485621,
        0.039033151475225,
        0.792981682333857,
        0.051956895132490,
        0.826943528363990,
        0.008799110700279,
        0.674111327346674,
        0.165713924746117,
        0.342875238126080,
        0.952751394795348,
        0.486233473130853,
        0.657426385161858,
        0.740735096261484,
        0.109927976537212,
        0.838795758110978,
        0.913919938722552,
        0.155420652349409,
        0.546238428894773,
        0.283505123187259,
        0.740646730859789,
        0.028270392857499,
        0.512547003441387,
        0.792814855356639,
        0.734736907792527,
        0.108183831433641,
        0.832940108733776,
        0.237840730117073,
        0.807787631216831,
        0.497128831862446,
        0.160825765137294,
        0.734040677567008,
        0.807912952139197,
        0.698901149985949,
        0.964846339026962,
        0.256144451205951,
        0.235762326997982,
        0.147230091811600,
        0.539406209950657,
        0.399448822385716,
        0.356662048714573,
        0.460304600931861,
        0.274542227929074,
        0.004260377665060,
        0.471750688851412,
        0.275884516508146,
        0.449783608929888,
        0.928875114011594,
        0.179005406834722,
        0.637483578006810,
        0.644414896262441,
        0.281293183556632,
        0.470887996729068,
        0.969611641631324,
        0.342460125401140,
        0.712345182452183,
        0.840219155681310,
        0.360691107716966,
        0.989914134053230,
        0.625869240477631,
        0.500985270593922,
        0.714907517506250,
        0.423829933866559,
        0.712326722843593,
        0.274802383334603,
        0.927208314345688,
        0.541962837933759,
        0.241649493587256,
        0.437196668431502,
        0.895096540620895,
        0.807055319072113,
        0.484468952038663,
        0.351701676740330,
        0.376247414102291,
        0.981195357595743,
        0.112212785131700,
        0.889023895569209,
        0.857608873426699,
        0.224388405937294,
        0.349358734167979,
        0.569559886725433,
        0.802392703740247,
        0.950445405338136,
        0.991808703583101,
        0.281231706882225,
        0.192363574340851,
        0.487725152667488,
        0.557563900934068,
        0.656704680393275,
        0.107591132314336,
        0.646356019355153,
        0.921379080678338,
        0.915201067829541,
        0.943773999300075,
        0.922339597531884,
        0.960777827482642,
        0.048692537116349,
        0.916018190702266,
        0.271212807892103,
        0.320665735466156,
        0.458614240947963,
        0.955280395007635,
        0.605088902655730,
        0.352693216652037,
        0.374157647552767,
        0.904928488823167,
        0.822347568235971,
        0.137537720235976,
        0.248681866157169,
        0.371945201069240,
        0.216741990290173,
        0.563481752713618,
        0.223638759945981,
        0.574924496446997,
        0.936024621406188,
        0.848675975533586,
        0.099263463082568,
        0.206904798370428,
        0.412749242263999,
        0.646127576659247,
        0.386566362834885,
        0.251612368340209,
        0.344659037128738,
        0.204013586529791,
        0.861866719522683,
        0.697251712343329,
        0.411029102405943,
        0.700431428209971,
        0.519729317478726,
        0.526262211158570,
        0.367355608463953,
        0.488218358572307,
        0.985516241695369,
        0.784464867312748,
        0.827700292651744,
        0.124371851424182,
        0.504273983084654,
        0.366900940402063,
        0.088906970727544,
        0.395277026236348,
        0.074187674732258,
        0.234019714465247,
        0.798762711251609,
        0.686217476243966,
        0.698546638346593,
        0.079357876930814,
        0.163982277587226,
        0.021584144070867,
        0.097514526910029,
        0.101218802428116,
        0.960144691621100,
        0.893951263471334,
        0.204253978553430,
        0.253812954707619,
        0.960877849135793,
        0.569997647125525,
        0.368523292689715,
        0.466544291475107,
        0.272209948677861,
        0.583577279989395,
        0.725271822389783,
        0.515448255738200,
        0.820666334538531,
        0.113210535060978,
        0.603652973857912,
        0.989602297305464,
        0.149079049867556,
        0.495036066395777,
        0.630145284441744,
        0.337529420211799,
        0.964617319252480,
        0.485410407692122,
        0.478698686317731,
        0.902663704426373,
        0.015910411244440,
        0.868885158976661,
        0.129073400787753,
        0.379168418226396,
        0.488456170430982,
        0.476558696915659,
        0.039408558168118,
        0.317107127394286,
        0.356794690367346,
        0.956179326863944,
        0.916985374978591,
        0.584348634196598,
        0.933367704937314,
        0.863712403344464,
        0.375722701116526,
        0.116966851055671,
        0.607137546900165,
        0.323009439198225,
        0.009742502911630,
        0.981179352124537,
        0.969276095448999,
        0.536806445779076,
        0.618185702219458,
        0.668866801761036,
        0.926538709044051,
        0.467508678029278,
        0.582878176454622,
        0.226539656503770,
        0.242398242505033,
        0.522112194722591,
        0.229204951410235,
        0.030252785430061,
        0.368407959481347,
        0.749945144136553,
        0.277070182795515,
        0.862703938488081,
        0.702502384733204,
        0.653319109148049,
        0.892483140903137,
        0.073811030749940,
        0.178765399504983,
        0.909270222459388,
        0.907037376819791,
        0.078267255898490,
        0.774231552555221,
        0.015432415436891,
        0.135235553368546,
        0.109760573693710,
        0.293995577818383,
        0.388268420643610,
        0.910873864270862,
        0.436397812772955,
        0.123849077393590,
        0.272348747150734,
        0.006376828101283,
        0.028049402896190,
        0.431068321456428,
        0.512188268191776,
        0.249961583279100,
        0.379892416692459,
        0.103368972691539,
        0.658821561774462,
        0.392605570467657,
        0.161525599474659,
        0.497393631286220,
        0.208374839752940,
        0.292129277966286,
        0.124170432861418,
        0.780730491164767,
        0.279315228275671,
        0.955676655905381,
        0.405431910896856,
        0.155194491682113,
        0.705212968993427,
        0.733558148258664,
        0.881319646023381,
        0.131512475929842,
        0.789885959077657,
        0.859759087461651,
        0.304518295195883,
        0.454482181611214,
        0.619641959041911,
        0.245513143317838,
        0.871355919631592,
        0.699194254911087,
        0.856683045869332,
        0.449915049918563,
        0.518998362932756,
        0.194254445030116,
        0.314024381595863,
        0.729512159519921,
        0.959007778167720,
        0.152102868420930,
        0.050643527733202,
        0.067452674119625,
        0.435471768821968,
        0.792671277316913,
        0.224877270039349,
        0.477132071395185,
        0.515402183663472,
        0.837702398077169,
        0.164033206983383,
        0.014718606080760,
        0.506655032325643,
        0.355245916780601,
        0.292165375856786,
        0.772237097456584,
        0.683467071380522,
        0.083937147680062,
        0.548103362726367,
        0.797844619110595,
        0.909684337475206,
        1.849190299395564e-04,
        0.807550098685804,
        0.043247927660589,
        0.682120580410576,
        0.598007103650569,
        0.952016292239996,
        0.631879092240196,
        0.069939064084080,
        0.670397983148165,
        0.254920416648672,
        0.831943993534743,
        0.031462089910604,
        0.324135823771549,
        0.676435886980024,
        0.155634800139984,
        0.646272009255702,
        0.697224805278189,
        0.733777664963868,
        0.875335192151078,
        0.413166116051979,
        0.142482973491241,
        0.260310930391146,
        0.389685401442653,
        0.054577570176633,
        0.708548829749348,
        0.063010647774122,
        0.057708757228460,
        0.932499537221799,
        0.806245878340841,
        0.253681046813631,
        0.341708091806300,
        0.825919699801219,
        0.619235464658352,
        0.264917616209675,
        0.449019195939970,
        0.855559587316900,
        6.913526320485586e-04,
        0.992393866454483,
        0.565933533985480,
        0.182020076790290,
        0.800192805760516,
        0.076195188027430,
        0.410000079369867,
        0.573132263268180
    ]

    returned_values_arrays = []
    for row in returned_values:
        returned_values_arrays.append(np.array(row))

    rand_mock.side_effect = returned_values_arrays
